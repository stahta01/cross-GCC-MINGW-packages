From 93d314969d4034e3e9b569525f0969f8d74528ce Mon Sep 17 00:00:00 2001
From: Tim S <tim.stahlhut@gmail.com>
Date: Fri, 12 Apr 2019 10:06:57 -0400
Subject: Part B of SVN247301

---
 gcc/ada/gcc-interface/Make-lang.in | 26 ++++++++++++++++++++++++--
 gcc/ada/gcc-interface/Makefile.in  | 20 ++++----------------
 2 files changed, 28 insertions(+), 18 deletions(-)

diff --git a/gcc/ada/gcc-interface/Make-lang.in b/gcc/ada/gcc-interface/Make-lang.in
index eb0489b4a50..d056a039c87 100644
--- a/gcc/ada/gcc-interface/Make-lang.in
+++ b/gcc/ada/gcc-interface/Make-lang.in
@@ -232,6 +232,7 @@ GNAT_ADA_OBJS =	\
  ada/a-chlat1.o	\
  ada/a-elchha.o	\
  ada/a-except.o	\
+ ada/a-exctra.o \
  ada/a-ioexce.o	\
  ada/ada.o	\
  ada/spark_xrefs.o	\
@@ -334,6 +335,7 @@ GNAT_ADA_OBJS =	\
  ada/rident.o	\
  ada/rtsfind.o	\
  ada/s-addope.o	\
+ ada/s-addima.o \
  ada/s-assert.o	\
  ada/s-bitops.o	\
  ada/s-carun8.o	\
@@ -351,9 +353,11 @@ GNAT_ADA_OBJS =	\
  ada/s-excdeb.o	\
  ada/s-except.o	\
  ada/s-exctab.o	\
+ ada/s-excmac.o \
  ada/s-htable.o	\
  ada/s-imenne.o	\
  ada/s-imgenu.o	\
+ ada/s-imgint.o \
  ada/s-mastop.o	\
  ada/s-memory.o	\
  ada/s-os_lib.o	\
@@ -381,6 +385,7 @@ GNAT_ADA_OBJS =	\
  ada/s-wchcnv.o	\
  ada/s-wchcon.o	\
  ada/s-wchjis.o	\
+ ada/s-wchstw.o \
  ada/scans.o	\
  ada/scil_ll.o	\
  ada/scn.o	\
@@ -534,10 +539,12 @@ GNATBIND_OBJS = \
  ada/s-crtl.o     \
  ada/s-excdeb.o   \
  ada/s-except.o   \
+ ada/s-excmac.o   \
  ada/s-exctab.o   \
  ada/s-htable.o   \
  ada/s-imenne.o   \
  ada/s-imgenu.o   \
+ ada/s-imgint.o   \
  ada/s-mastop.o   \
  ada/s-memory.o   \
  ada/s-os_lib.o   \
@@ -594,6 +601,21 @@ ADA_BACKEND = $(BACKEND) attribs.o
 # List of target dependent sources, overridden below as necessary
 TARGET_ADA_SRCS =
 
+# Select the right s-excmac according to exception layout (Itanium or arm)
+host_cpu=$(word 1, $(subst -, ,$(host)))
+EH_MECHANISM=-gcc
+ifeq ($(strip $(filter-out arm%,$(host_cpu))),)
+EH_MECHANISM=-arm
+endif
+
+ada/s-excmac.o: ada/s-excmac.ads ada/s-excmac.adb
+
+ada/s-excmac.ads: $(srcdir)/ada/s-excmac$(EH_MECHANISM).ads
+	$(CP) $< $@
+
+ada/s-excmac.adb: $(srcdir)/ada/s-excmac$(EH_MECHANISM).adb
+	$(CP) $< $@
+
 # Needs to be built with CC=gcc
 # Since the RTL should be built with the latest compiler, remove the
 #  stamp target in the parent directory whenever gnat1 is rebuilt
@@ -976,12 +998,12 @@ ada/sdefault.o : ada/ada.ads ada/a-except.ads ada/a-unccon.ads \
 
 # Special flags - see gcc-interface/Makefile.in for the template.
 
-ada/a-except.o  : ada/a-except.adb ada/a-except.ads
+ada/a-except.o : ada/a-except.adb ada/a-except.ads ada/s-excmac.ads ada/s-excmac.adb
 	$(CC) -c $(ALL_ADAFLAGS) $(FORCE_DEBUG_ADAFLAGS) -O1 -fno-inline \
 	 $(ADA_INCLUDES) $< $(OUTPUT_OPTION)
 	@$(ADA_DEPS)
 
-ada/s-excdeb.o  : ada/s-excdeb.adb ada/s-excdeb.ads
+ada/s-excdeb.o : ada/s-excdeb.adb ada/s-excdeb.ads
 	$(CC) -c $(ALL_ADAFLAGS) $(FORCE_DEBUG_ADAFLAGS) -O0 \
 	 $(ADA_INCLUDES) $< $(OUTPUT_OPTION)
 	@$(ADA_DEPS)
diff --git a/gcc/ada/gcc-interface/Makefile.in b/gcc/ada/gcc-interface/Makefile.in
index 14269e271e1..b65ec2c7506 100644
--- a/gcc/ada/gcc-interface/Makefile.in
+++ b/gcc/ada/gcc-interface/Makefile.in
@@ -2427,32 +2427,20 @@ endif
 
 ifeq ($(EH_MECHANISM),-gcc)
   LIBGNAT_TARGET_PAIRS += \
-    a-exexpr.adb<a-exexpr-gcc.adb \
-    s-excmac.ads<s-excmac-gcc.ads
+    s-excmac.ads<s-excmac-gcc.ads \
+    s-excmac.adb<s-excmac-gcc.adb
   EXTRA_LIBGNAT_OBJS+=raise-gcc.o
   EXTRA_GNATRTL_NONTASKING_OBJS+=g-cppexc.o s-excmac.o
 endif
 
 ifeq ($(EH_MECHANISM),-arm)
   LIBGNAT_TARGET_PAIRS += \
-    a-exexpr.adb<a-exexpr-gcc.adb \
-    s-excmac.ads<s-excmac-arm.ads
+    s-excmac.ads<s-excmac-arm.ads \
+    s-excmac.adb<s-excmac-arm.adb
   EXTRA_LIBGNAT_OBJS+=raise-gcc.o
   EXTRA_GNATRTL_NONTASKING_OBJS+=g-cppexc.o s-excmac.o
 endif
 
-# Use the Ada 2005 version of Ada.Exceptions by default, unless specified
-# explicitly already. The base files (a-except.ad?) are used only for building
-# the compiler and other basic tools.
-# These base versions lack Ada 2005 additions which would cause bootstrap
-# problems if included in the compiler and other basic tools.
-
-ifeq ($(filter a-except%,$(LIBGNAT_TARGET_PAIRS)),)
-  LIBGNAT_TARGET_PAIRS += \
-    a-except.ads<a-except-2005.ads \
-    a-except.adb<a-except-2005.adb
-endif
-
 # Configuration of host tools
 
 # Under linux, host tools need to be linked with -ldl
-- 
